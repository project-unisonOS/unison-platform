name: Platform Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  build-artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-utils xorriso python3-yaml
          COSIGN_VERSION="v2.2.4"
          curl -sSfL "https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64" -o /tmp/cosign
          sudo install -m 0755 /tmp/cosign /usr/local/bin/cosign

      - name: Build platform artifacts
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          make image-wsl image-vm image-iso

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push platform image
        env:
          IMAGE: ghcr.io/${{ github.repository_owner }}/unison-platform:${{ github.ref_name }}
        run: |
          IMAGE_LOWER=$(echo "$IMAGE" | tr '[:upper:]' '[:lower:]')
          docker build -t "$IMAGE_LOWER" .
          docker push "$IMAGE_LOWER"
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE_LOWER")
          cosign verify --version >/dev/null 2>&1 || true
          COSIGN_EXPERIMENTAL=1 cosign sign --yes "$DIGEST"

      - name: Verify images signed (keyless)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          : # Skipping WSL/VM cosign verify until those images are published to GHCR

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: unison-platform-${{ github.ref_name }}-artifacts
          path: |
            images/out/unisonos-wsl-${{ github.ref_name }}*.tar.gz
            images/out/unisonos-vm-${{ github.ref_name }}/**
            images/out/unisonos-iso-${{ github.ref_name }}/**
            images/out/unisonos-autoinstall-seed-${{ github.ref_name }}.iso

      - name: Publish GitHub Release assets
        uses: softprops/action-gh-release@v2.5.0
        with:
          files: |
            images/out/unisonos-wsl-${{ github.ref_name }}*.tar.gz
            images/out/unisonos-vm-${{ github.ref_name }}/unisonos-vm-${{ github.ref_name }}.qcow2
            images/out/unisonos-vm-${{ github.ref_name }}/unisonos-vm-${{ github.ref_name }}.vmdk
            images/out/unisonos-vm-${{ github.ref_name }}/metadata.json
            images/out/unisonos-iso-${{ github.ref_name }}/autoinstall/user-data
            images/out/unisonos-iso-${{ github.ref_name }}/autoinstall/meta-data
            images/out/unisonos-iso-${{ github.ref_name }}/autoinstall/models.json
            images/out/unisonos-autoinstall-seed-${{ github.ref_name }}.iso
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
