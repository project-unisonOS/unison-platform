name: Platform Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  build-artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-utils xorriso python3-yaml

      - name: Build platform artifacts
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          make image-wsl image-vm image-iso

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push platform image
        env:
          IMAGE: ghcr.io/${{ github.repository_owner }}/unison-platform:${{ github.ref_name }}
        run: |
          IMAGE_LOWER=$(echo "$IMAGE" | tr '[:upper:]' '[:lower:]')
          docker build -t "$IMAGE_LOWER" .
          cosign verify --version >/dev/null 2>&1 || true
          COSIGN_EXPERIMENTAL=1 cosign sign --yes "$IMAGE_LOWER"
          docker push "$IMAGE_LOWER"

      - name: Verify images signed (keyless)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          cosign verify --certificate-oidc-issuer https://token.actions.githubusercontent.com --certificate-identity-regexp "https://github.com/${{ github.repository }}" \
            ghcr.io/${{ github.repository_owner }}/unisonos-wsl:${{ github.ref_name }}
          cosign verify --certificate-oidc-issuer https://token.actions.githubusercontent.com --certificate-identity-regexp "https://github.com/${{ github.repository }}" \
            ghcr.io/${{ github.repository_owner }}/unisonos-vm:${{ github.ref_name }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: unison-platform-${{ github.ref_name }}-artifacts
          path: |
            images/out/unisonos-wsl-${{ github.ref_name }}*.tar.gz
            images/out/unisonos-vm-${{ github.ref_name }}/**
            images/out/unisonos-iso-${{ github.ref_name }}/**
            images/out/unisonos-autoinstall-seed-${{ github.ref_name }}.iso

      - name: Publish GitHub Release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            images/out/unisonos-wsl-${{ github.ref_name }}*.tar.gz
            images/out/unisonos-vm-${{ github.ref_name }}/unisonos-vm-${{ github.ref_name }}.qcow2
            images/out/unisonos-vm-${{ github.ref_name }}/unisonos-vm-${{ github.ref_name }}.vmdk
            images/out/unisonos-vm-${{ github.ref_name }}/metadata.json
            images/out/unisonos-iso-${{ github.ref_name }}/user-data
            images/out/unisonos-iso-${{ github.ref_name }}/meta-data
            images/out/unisonos-iso-${{ github.ref_name }}/models.json
            images/out/unisonos-autoinstall-seed-${{ github.ref_name }}.iso
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
